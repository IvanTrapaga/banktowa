<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="/bower_components/polymer/lib/elements/dom-if.html">

<link rel="import" href="/src/banktowa-app-app/banktowa-traspaso/banktowa-traspaso-importe.html">

<link rel="import" href="/src/banktowa-app-app/banktowa-traspaso/banktowa-traspaso-mensaje.html">

<link rel="import" href="/src/banktowa-app-app/banktowa-traspaso/banktowa-traspaso-comprobante.html">

<dom-module id="banktowa-traspaso">
    <template>
<!--
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
            <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    -->        

    <style>
      :host {
        display: block;    

        background-color: var(--bg-color-cmp,#FAFAFA);    
      }

      :host,table, div{    
        width: 92%;
        height: auto;
        margin: 0% 4% 0% 4%;
      }

      table,div {
          margin-top: 4%;
          border-style: double;
      }

      .labels {
        --label-traspaso: 20px;
        font-size: var(--label-traspaso);
        font-weight: bold;
      }

      select,input{
          width: var(--width-select, 80%);
          height: var(--height-select,50px);
          font-size: var(--label-traspaso);
      }

      button {
        width: var(--width-button, 30%);
        height: var(--height-button, 50px);
        font-size: var(--label-traspaso);
        margin: 0% 4% 0% 4%;
      }

      table{
          border-style: solid;
      }
    </style>
    <div>
    <table cellspacing="0px" >
        <tbody>
            <tr>
                <td width="20%"><span class="labels">Cuenta Origen:</span></td>
                <td width="50%">
                        <select on-change="funSelectItemChangeOrigen" size="[[sizeItems]]">
                                <template is="dom-repeat" items=[[cuentasOrigen]]>
                                <option value="[[item.num_cuenta]]">[[item.cuenta]]</option>
                                </template>
    </select>
    </td>
    <td width="30%"></td>
    </tr>
    <tr>
        <td><span class="labels">Cuenta Destino:</span></td>
        <td>
            <select on-change="funSelectItemChangeDestino" size="[[sizeItems]]">
                <template is="dom-repeat" items=[[cuentasDestino]]>
                        <option value="[[item.no_cuenta]]">[[item.cuenta]]</option>
                </template>
                </select>
        </td>
        <td></td>
    </tr>
    <tr>
        <td><span class="labels">Importe:</span></td>
        <td>
            <banktowa-traspaso-importe strimporte={{importe}}></banktowa-traspaso-importe>
        </td>
        <td></td>
    </tr>
    <tr>
        <td colspan="3" align="right"><button on-click="traspasar">Traspasar</button></td>
    </tr>
    </tbody>
    </table>
    </div>

    <template is="dom-if" if="[[mensajes]]">
    <div>
        <banktowa-traspaso-mensaje importe=[[importe]] cuenta=[[cuentaSelect]] mensaje={{mensajes}} comprobante={{comprobante}}></banktowa-traspaso-mensaje>
    </div>
    </template>

    <template is="dom-if" if="[[comprobante]]">
    <div>
        <banktowa-traspaso-comprobante comprobante=[[comprobante]] cuentaSelectDst=[[cuentaSelect]] 
        cuentaSelectSrc=[[cuentaSelectSrc]] importe=[[importe]]></banktowa-traspaso-comprobante>
    </div>
    </template>

    </template>

    <script>
        class cuentaCliente {
            constructor(json) {
                this.id = json.id;
                this.id_cliente = json.id_cliente;
                this.num_cuenta = json.num_cuenta;
                this.tipo_cuenta = json.tipo_cuenta;
                this.producto = json.producto;
                this.saldo = json.saldo;
                this.cuenta = "ITEM";
            }
        }

        class cuentaDestino {
            constructor(json) {
                this.id = json.id
                this.id_cliente = json.id_cliente
                this.no_cuenta = json.no_cuenta
                this.alias = json.alias
                this.cuenta = ""
            }
        }


        class BanktowaTraspaso extends Polymer.Element {
            static get is() {
                return 'banktowa-traspaso';
            }
            static get properties() {
                return {
                    module: {
                        type: String,
                        value: 'banktowa-traspaso'
                    },

                    server: {
                        type: String,
                        value: 'http://localhost:3000'
                    },

                    cliente_login: {
                        type: String,
                        value: "1114"
                    },

                    cuentasOrigen: {
                        type: Array,
                        value: []
                    },

                    cuentasDestino: {
                        type: Array,
                        value: []
                    },
                    sizeItems: {
                        type: Number,
                        value: 1
                    },

                    importe: {
                        type: String,
                        value: "1.00",
                        notify: true
                    },
                    cuentaSelect: {
                        type: Object,
                        value: {
                            id: 0,
                            no_cuenta: "45238080149063",
                            alias: "cuenta destino",
                            id_cliente: "1"
                        },
                        notify: true
                    },

                    cuentaSelectSrc: {
                        type: Object,
                        value: {
                            id: 0,
                            no_cuenta: "45238080149063",
                            alias: "cuenta destino",
                            id_cliente: "1"
                        },
                        notify: true
                    },

                    mensajes: {
                        type: Boolean,
                        value: false
                    },

                    comprobante: {
                        type: Boolean,
                        value: false
                    }


                };
            }

            //---------------------------------------------------------------------------------------------------------
            constructor() {
                super();

                var recurso = `${this.server}/cuentasClientes?id_cliente=${this.cliente_login}`;
                this.getCuentasCliente(recurso).then(data => {
                    console.log("getCuentasCliente Src", data);

                    let arr = new Array();
                    data.forEach(el => {
                        let cuenta = new cuentaCliente(el);
                        cuenta.cuenta = this.generateItemCuenta(el.tipo_cuenta, el.num_cuenta);
                        arr.push(cuenta)
                    });
                    this.set('cuentasOrigen', arr);
                    this.set('cuentaSelectSrc', this.cuentasOrigen[0]);
                }).catch(error => console.log("Hubo un problema... " + error.message)).then(console.log("getCuentasCliente Src .... OK"))

                recurso = `${this.server}/cuentasDestino?id_cliente=${this.cliente_login}`;
                this.getCuentasCliente(recurso).then(data => {
                    console.log("getCuentasCliente Dst", data);

                    let arr = new Array();
                    data.forEach(el => {
                        let cuenta = new cuentaDestino(el);
                        cuenta.cuenta = this.generateItemCuenta(el.alias, el.no_cuenta, " - ");
                        arr.push(cuenta)
                    });

                    this.set('cuentasDestino', arr);
                    this.set('cuentaSelect', this.cuentasDestino[0]);

                }).catch(error => console.log("Hubo un problema... " + error.message)).then(console.log("getCuentasCliente Dst .... OK"))
            }

            //---------------------------------------------------------------------------------------------------------
            funSelectItemChangeOrigen(ev) {

                let idxSelect = ev.target.selectedIndex;
                let itemSelect = ev.target.options[idxSelect].value;

                this.set('cuentaSelectSrc', this.cuentasOrigen[idxSelect]);
                //console.info(idxSelect, itemSelect);
            }

            funSelectItemChangeDestino(ev) {

                let idxSelect = ev.target.selectedIndex;
                let itemSelect = ev.target.options[idxSelect].value;

                this.set('cuentaSelect', this.cuentasDestino[idxSelect]);
                //console.info("cuenta destino", idxSelect, itemSelect);
            }


            //---------------------------------------------------------------------------------------------------------
            async getCuentasCliente(recurso) {

                var myHeaders = new Headers();
                myHeaders.append('Content-Type', 'application/json');
                myHeaders.append("X-Custom-Header", "ProcessThisImmediately");

                var myInit = {
                    method: 'GET',
                    headers: myHeaders,
                    mode: 'cors',
                    cache: 'default',
                    credentials: 'omit'
                };

                var myRequest = new Request(recurso, myInit);
                let response = await fetch(myRequest);

                console.log(`Response [${response.ok}] : status = ${response.status}-${response.statusText}`, recurso);
                if (response.ok && response.status === 200) {
                    var contentType = response.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return response.json();
                    } else {
                        console.log("Oops, we haven't got JSON!");
                        return response.text();
                    }
                } else {
                    console.log("Error en la red :: getCuentasClientes");
                }
            }

            //---------------------------------------------------------------------------------------------------------
            generateItemCuenta(tc, nc, separador = " ") {
                return `${tc}${separador}${nc}`;
            }

            //---------------------------------------------------------------------------------------------------------
            traspasar() {
                let numImp = parseFloat(this.importe);
                console.log("traspasar", numImp);
                if (numImp >= 1 && numImp < 100000000) {
                    this.set('mensajes', true);
                } else {
                    document.querySelector('banktowa-traspaso-importe').focus();
                }
            }

            //---------------------------------------------------------------------------------------------------------

        }
        window.customElements.define(BanktowaTraspaso.is, BanktowaTraspaso);
    </script>
</dom-module>